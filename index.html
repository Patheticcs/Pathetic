<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline';">
    <title>Key System</title>
    <meta name="description" content="Secure key validation system">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px)
        }

        to {
          opacity: 1;
          transform: translateY(0)
        }
      }

      @keyframes gradientMove {
        0% {
          background-position: 0 50%
        }

        50% {
          background-position: 100% 50%
        }

        100% {
          background-position: 0 50%
        }
      }

      @keyframes glowPulse {

        0%,
        100% {
          box-shadow: 0 0 20px rgba(255, 255, 255, .2)
        }

        50% {
          box-shadow: 0 0 40px rgba(255, 255, 255, .4)
        }
      }

      @keyframes borderFlow {
        0% {
          background-position: 0 0
        }

        100% {
          background-position: 200% 0
        }
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0, #c3cfe2 100%);
        min-height: 100vh;
        display: flex;
        color: #2d3436;
        min-height: 100vh;
        justify-content: center;
        align-items: center;
        margin: 0;
        overflow: hidden;
        position: relative
      }

      .glass-overlay {
        position: fixed;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle at center, transparent 0, rgba(0, 0, 0, .4) 100%);
        pointer-events: none;
        z-index: 1
      }

      .container {
        border-radius: 40px;
        background: rgba(255, 255, 255, .25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, .3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, .3);
        text-align: center;
        transition: all .5s ease-out;
        min-height: 450px;
        width: 650px;
        position: relative;
        overflow: hidden
      }

      .container::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(120deg, transparent, rgba(255, 255, 255, .3), transparent);
        transition: .5s
      }

      .container:hover::before {
        left: 100%
      }

      h2 {
        font-size: 3.2em;
        margin-top: 50px;
        color: #000;
        margin-bottom: 1.5em;
        text-align: center;
        position: relative;
        text-transform: uppercase;
        letter-spacing: 3px;
        text-shadow: 0 0 10px rgba(255, 255, 255, .3);
        animation: fadeIn .8s ease-out .2s backwards
      }

      .input-group {
        position: relative;
        margin: 2em 0;
        animation: fadeIn .8s ease-out .4s backwards
      }

      input[type=text] {
        margin-top: 0;
        width: 80%;
        padding: 15px 20px;
        font-size: 1em;
        background: rgba(255, 255, 255, .07);
        border: 1px solid rgba(0, 0, 0, .1);
        border-radius: 15px;
        color: #000;
        outline: 0;
        transition: all .3s cubic-bezier(.4, 0, .2, 1)
      }

      input[type=text]:hover {
        background: rgba(255, 255, 255, .09);
        box-shadow: 0 0 20px rgba(0, 0, 0, .1)
      }

      input[type=text]:focus {
        border-color: rgba(0, 0, 0, .3);
        background: rgba(255, 255, 255, .11);
        box-shadow: 0 0 25px rgba(0, 0, 0, .2)
      }

      .button-group {
        display: flex;
        gap: 1.5em;
        justify-content: center;
        margin-top: 2em;
        animation: fadeIn .8s ease-out .6s backwards
      }

      button {
        padding: 12px 30px;
        border: none;
        border-radius: 12px;
        background: rgba(255, 255, 255, .1);
        color: #000;
        font-size: 1em;
        cursor: pointer;
        transition: all .3s cubic-bezier(.4, 0, .2, 1);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(0, 0, 0, .1);
        position: relative;
        margin-top: 40px;
        overflow: hidden
      }

      button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .2), transparent);
        transition: .5s
      }

      button:hover {
        background: rgba(255, 255, 255, .15);
        box-shadow: 0 0 15px rgba(0, 0, 0, .1)
      }

      button:hover::before {
        left: 100%
      }

      button i {
        margin-right: 8px;
        transition: transform .3s ease
      }

      button:hover i {
        transform: scale(1.03)
      }
      
      button:hover {
        transform: scale(1.03)
      }

      .alert {
        margin-top: 1.5em;
        padding: 1px;
        height: 50px;
        width: 500px;
        border-radius: 12px;
        background: rgba(255, 59, 48, .15);
        color: rgba(255, 255, 255, .9);
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
        overflow: hidden;
        margin-left: 75px;
        transition: all .3s cubic-bezier(.4, 0, .2, 1);
        backdrop-filter: blur(5px);
        margin-bottom: 20px
      }

      .alert.show {
        opacity: 1;
        transform: translateY(0);
        max-height: 100px
      }

      @keyframes shake {

        0%,
        100% {
          transform: translateX(0)
        }

        25% {
          transform: translateX(-10px)
        }

        75% {
          transform: translateX(10px)
        }
      }

      .shake {
        animation: shake .5s cubic-bezier(.36, .07, .19, .97) both
      }
    </style>
  </head>
  <body>
    <div class="container" id="login-container">
      <form id="keyForm" onsubmit="handleSubmit(event)">
        <h2>Key System</h2>
        <div class="input-group">
          <input 
            type="text" 
            id="key" 
            name="key"
            placeholder="Enter your access key"
            autocomplete="off"
            maxlength="50"
            pattern="[A-Za-z0-9-_]+"
            required
          >
        </div>
        <div class="button-group">
          <button type="submit" id="submitBtn">
            <i class="fas fa-key"></i>
            Submit
          </button>
          <button type="button" onclick="handleDiscord()" id="discordBtn">
            <i class="fab fa-discord"></i>
            Get Key
          </button>
        </div>
      </form>
      <div id="alert" class="alert" role="alert"></div>
    </div>

    <script>
      function sanitizeInput(input) {
        return input.replace(/[^A-Za-z0-9-_]/g, '');
      }

      async function validateKey(key) {
        try {
          const response = await fetch('/api/validate-key', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
            },
            body: JSON.stringify({ key: sanitizeInput(key) })
          });
          
          if (!response.ok) throw new Error('Network response was not ok');
          return await response.json();
        } catch (error) {
          console.error('Error:', error);
          throw new Error('Failed to validate key');
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();
        
        const keyInput = document.getElementById('key');
        const submitBtn = document.getElementById('submitBtn');
        const alertEl = document.getElementById('alert');
        const container = document.getElementById('login-container');
        
        // Disable form while processing
        submitBtn.disabled = true;
        keyInput.disabled = true;
        
        try {
          const sanitizedKey = sanitizeInput(keyInput.value.trim());
          if (!sanitizedKey) {
            throw new Error('Please enter a valid key');
          }

          const result = await validateKey(sanitizedKey);
          
          if (result.valid) {
            showAlert('Success! Redirecting...', true);
            sessionStorage.setItem('authToken', result.token);
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 1500);
          } else {
            throw new Error('Invalid key');
          }
        } catch (error) {
          showAlert(error.message || 'An error occurred. Please try again.');
          container.classList.add('shake');
          setTimeout(() => container.classList.remove('shake'), 500);
        } finally {
          submitBtn.disabled = false;
          keyInput.disabled = false;
          keyInput.focus();
        }
      }

      function showAlert(message, isSuccess = false) {
        const alertEl = document.getElementById('alert');
        alertEl.textContent = message;
        alertEl.classList.toggle('success', isSuccess);
        alertEl.classList.add('show');
      }

      function handleDiscord() {
        const discordUrl = 'https://discord.gg/Eg2EWXwYcn';
        window.open(discordUrl, '_blank', 'noopener,noreferrer');
      }

      // Check auth state on page load
      document.addEventListener('DOMContentLoaded', () => {
        const authToken = sessionStorage.getItem('authToken');
        if (authToken) {
          fetch('/api/verify-token', {
            headers: { 'Authorization': `Bearer ${authToken}` }
          })
          .then(response => {
            if (response.ok) {
              window.location.href = '/dashboard';
            } else {
              sessionStorage.removeItem('authToken');
            }
          })
          .catch(() => {
            sessionStorage.removeItem('authToken');
          });
        }
      });
    </script>
  </body>
</html>
